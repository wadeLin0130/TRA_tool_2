<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程預算變更工具</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 替換為支援樣式的 xlsx-js-style -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #999; padding: 4px; font-size: 13px; }
        th { background: #eee; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .step-active { font-weight: bold; color: blue; }
        .step-inactive { color: gray; }
        input[type="text"] { width: 90%; }
        button { cursor: pointer; padding: 5px 10px; margin-right: 5px; }
        .nowrap { white-space: nowrap; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ExcelProcessor = () => {
            const [step, setStep] = useState(1);
            const [inputData, setInputData] = useState([]);
            const [outputData, setOutputData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [changeQtyKey, setChangeQtyKey] = useState('');
            const [ratioKey, setRatioKey] = useState('');
            const [libLoaded, setLibLoaded] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const fileInputRef = useRef(null);

            const BASE_ITEM_CODE = '011';
            const SUMMARY_CODES = ['01', '011', '012', '013', '014']; 

            useEffect(() => {
                if (window.XLSX) {
                    setLibLoaded(true);
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.XLSX) {
                            setLibLoaded(true);
                            clearInterval(checkInterval);
                        }
                    }, 500);
                }
            }, []);

            // 輔助函式：四捨五入至小數點後 2 位
            const round2 = (num) => {
                return Math.round((num + Number.EPSILON) * 100) / 100;
            };

            const parseNum = (val) => {
                if (val === undefined || val === null || val === '') return 0;
                if (typeof val === 'number') return val;
                const str = String(val).replace(/,/g, '').trim();
                const num = parseFloat(str);
                return isNaN(num) ? 0 : num;
            };

            // 格式化顯示數字 (千分位 + 2位小數)
            const formatNum = (num) => {
                if (num === undefined || num === null || num === '') return '';
                return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            const downloadTemplate = () => {
                if (!window.XLSX) return;
                // 1. 簡化範本：移除金額合計
                const ws = window.XLSX.utils.aoa_to_sheet([
                    ["工程項目", "項目名稱", "單位", "數量", "單價", "變更後數量", "按比例"]
                ]);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "空白預算書");
                window.XLSX.writeFile(wb, "空白預算書.xlsx");
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                setStatusMsg('讀取與清洗資料中...');
                
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const wb = window.XLSX.read(data, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        let json = window.XLSX.utils.sheet_to_json(ws);
                        
                        // 基礎清洗：Trim keys
                        json = json.map(row => {
                            const newRow = {};
                            Object.keys(row).forEach(key => newRow[key.trim()] = row[key]);
                            return newRow;
                        });

                        if (json.length === 0) { alert("檔案內容為空"); setStatusMsg(''); return; }
                        // 允許簡化輸入，不強制檢查「金額合計」
                        if (!json[0]['工程項目']) { alert('錯誤：找不到「工程項目」欄位'); setStatusMsg(''); return; }

                        const keys = Object.keys(json[0]);
                        const foundChangeKey = keys.find(k => k.includes('變更後數量')) || keys.find(k => k.includes('變更數量')) || '變更後數量';
                        const foundRatioKey = keys.find(k => k.includes('按比例')) || '按比例';
                        
                        setChangeQtyKey(foundChangeKey);
                        setRatioKey(foundRatioKey);

                        // --- 資料前處理 (Data Pre-processing) ---
                        // 2. 系統自行計算純子項總價，並補全 01/011
                        const processedData = preprocessInputData(json, foundChangeKey, foundRatioKey);

                        setInputData(processedData);
                        setStep(2);
                        setStatusMsg(`已讀取並處理 ${processedData.length} 筆資料`);
                    } catch (error) { 
                        console.error(error); 
                        alert("讀取失敗：" + error.message);
                        setStatusMsg('');
                    }
                };
            };

            // 輸入資料預處理邏輯 (清洗時計算父項)
            const preprocessInputData = (rawData, changeKey, ratioKey) => {
                // 1. 轉換為標準格式物件
                let items = rawData.map((row, idx) => ({
                    id: idx,
                    code: String(row['工程項目'] || '').trim(),
                    name: row['項目名稱'] || '',
                    unit: row['單位'] || '',
                    qty: parseNum(row['數量']),
                    price: parseNum(row['單價']),
                    total: 0, // 待計算
                    changeQtyVal: row[changeKey],
                    isRatioItem: !!row[ratioKey],
                    rawRow: row // 保留原始參照
                }));

                // 2. 檢查並補全 01 與 011
                const hasCode = (c) => items.some(i => i.code === c);
                
                // 4. 如果沒有 011，自動新增
                if (!hasCode('011')) {
                    items.push({
                        id: 'auto_011', code: '011', name: '包工費', unit: '式', qty: 1, price: 0, total: 0, 
                        changeQtyVal: '', isRatioItem: false, rawRow: {}
                    });
                }
                // 4. 如果沒有 01，自動新增
                if (!hasCode('01')) {
                    items.push({
                        id: 'auto_01', code: '01', name: '發包工程費', unit: '式', qty: 1, price: 0, total: 0, 
                        changeQtyVal: '', isRatioItem: false, rawRow: {}
                    });
                }

                // 重新排序
                items.sort((a, b) => a.code.localeCompare(b.code));

                // 識別純子項 (Leaf)
                const allCodes = items.map(i => i.code);
                items.forEach(item => {
                    const isLeaf = !allCodes.some(other => other.startsWith(item.code) && other !== item.code);
                    item.isLeaf = isLeaf;
                });

                // 3. 計算金額
                // 先算純子項
                items.forEach(item => {
                    if (item.isLeaf) {
                        // 2. 純子項金額 = 數量 * 單價 (使用 round2 計算至小數點後2位)
                        item.total = round2(item.qty * item.price);
                    } else {
                        item.total = 0; // 父項先歸零，等等累加
                    }
                });

                // 3. 計算所有父項金額 (由長代碼到短代碼，Bottom-up)
                const sortedByLenDesc = [...items].sort((a, b) => b.code.length - a.code.length);
                
                sortedByLenDesc.forEach(child => {
                    const potentialParent = sortedByLenDesc.find(p => 
                        child.code.startsWith(p.code) && 
                        child.code !== p.code &&
                        !sortedByLenDesc.some(middle => middle.code.startsWith(p.code) && child.code.startsWith(middle.code) && middle.code !== p.code && middle.code !== child.code)
                    );

                    if (potentialParent) {
                        // 父項累加也要保持 2 位小數精度
                        potentialParent.total = round2(potentialParent.total + child.total);
                        // 父項的單價通常等於總價(如果是式)
                        if (potentialParent.unit === '式' && potentialParent.qty === 1) {
                            potentialParent.price = potentialParent.total;
                        }
                    }
                });

                // 將計算結果寫回原始結構供 UI 顯示
                return items.map(item => {
                    const newRow = { ...item.rawRow };
                    newRow['工程項目'] = item.code;
                    newRow['項目名稱'] = item.name;
                    newRow['單位'] = item.unit;
                    newRow['數量'] = item.qty;
                    newRow['單價'] = item.price;
                    newRow['金額合計'] = item.total; // 供 UI 顯示 (已是 2 位小數精度)
                    newRow[changeKey] = item.changeQtyVal;
                    if(item.isRatioItem) newRow[ratioKey] = 'V';
                    return newRow;
                });
            };

            const handleInputChange = (index, field, value) => {
                const newData = [...inputData];
                newData[index][field] = value;
                setInputData(newData);
            };

            const validateData = (allItems) => {
                const errors = [];
                const allCodes = allItems.map(i => i.code);
                allItems.forEach(item => {
                    const isLeaf = !allCodes.some(otherCode => otherCode.startsWith(item.code) && otherCode !== item.code && otherCode.length > item.code.length);
                    if (item.isRatioItem) {
                        if (!isLeaf) return; 
                        const changeQty = parseNum(item.changeQtyVal);
                        const isZeroQty = (item.changeQtyVal !== undefined && item.changeQtyVal !== '' && item.changeQtyVal !== null) && changeQty === 0;
                        if (isZeroQty) return;
                        if (item.unit !== '式' || item.originalQty !== 1) {
                            errors.push(`項目 [${item.code} ${item.name}]：勾選按比例，但單位不是"式"或原數量不是 1。`);
                        }
                    }
                });
                return errors;
            };

            const generateRawCategoryItems = (allItems, categoryType) => {
                const allCodes = allItems.map(i => i.code);
                const processedAllItems = allItems.map(item => {
                    let isRatioItem = item.isRatioItem;
                    const isLeaf = !allCodes.some(otherCode => otherCode.startsWith(item.code) && otherCode !== item.code && otherCode.length > item.code.length);
                    if (isRatioItem) {
                        if (!isLeaf) {
                            isRatioItem = false;
                        } else {
                            const changeQty = parseNum(item.changeQtyVal);
                            if ((item.changeQtyVal !== undefined && item.changeQtyVal !== '' && item.changeQtyVal !== null) && changeQty === 0) {
                                isRatioItem = false; 
                            }
                        }
                    }
                    return { ...item, isRatioItem };
                });

                const normalLeafItems = processedAllItems.filter(item => {
                    const isLeaf = !allCodes.some(otherCode => otherCode.startsWith(item.code) && otherCode !== item.code && otherCode.length > item.code.length);
                    return isLeaf && !item.isRatioItem;
                });

                const ratioItems = processedAllItems.filter(item => item.isRatioItem);

                let targetLeaves = [];
                if (categoryType === 'NEW_ITEM') {
                    targetLeaves = normalLeafItems.filter(item => item.originalQty === 0);
                } else if (categoryType === 'NO_CHANGE') {
                    targetLeaves = normalLeafItems.filter(item => item.originalQty > 0 && (item.changeQtyVal === undefined || item.changeQtyVal === '' || item.changeQtyVal === null));
                } else if (categoryType === 'ADD') {
                    targetLeaves = normalLeafItems.filter(item => {
                        if (item.originalQty === 0) return false;
                        const newVal = parseNum(item.changeQtyVal);
                        return (item.changeQtyVal !== undefined && item.changeQtyVal !== '' && item.changeQtyVal !== null) && (newVal > item.originalQty);
                    });
                } else if (categoryType === 'DEDUCT') {
                    targetLeaves = normalLeafItems.filter(item => {
                        if (item.originalQty === 0) return false;
                        const newVal = parseNum(item.changeQtyVal);
                        return (item.changeQtyVal !== undefined && item.changeQtyVal !== '' && item.changeQtyVal !== null) && (newVal < item.originalQty);
                    });
                }

                let combinedTargets = [...targetLeaves, ...ratioItems];
                if (combinedTargets.length === 0) return [];

                const relevantCodes = new Set(combinedTargets.map(i => i.code));
                
                const resultItems = processedAllItems.filter(item => {
                    if (relevantCodes.has(item.code)) return true;
                    return combinedTargets.some(leaf => leaf.code.startsWith(item.code));
                });

                resultItems.sort((a, b) => a.code.localeCompare(b.code));
                const resultCodes = resultItems.map(i => i.code);

                return resultItems.map(item => {
                    const isLeafInContext = item.isRatioItem || !resultCodes.some(other => other.startsWith(item.code) && other !== item.code);
                    const rowData = {
                        code: item.code, name: item.name, unit: item.unit, isLeaf: isLeafInContext, isRatioItem: item.isRatioItem, category: categoryType,
                        originalQty: 0, originalPrice: 0, originalTotal: 0, newQty: 0, newPrice: 0, newTotal: 0, diffQty: 0, diffPrice: 0, diffTotal: 0, formulaPrice: null
                    };

                    if (isLeafInContext) {
                        if (item.isRatioItem) {
                            rowData.needsRatioCalc = true;
                            rowData.originalQty = 1; rowData.originalPrice = item.originalPrice; rowData.originalTotal = item.originalTotal; rowData.newQty = 1; 
                        } else {
                            rowData.originalQty = item.originalQty; rowData.originalPrice = item.originalPrice; rowData.originalTotal = item.originalQty * item.originalPrice;
                            if (categoryType === 'NEW_ITEM') {
                                rowData.originalQty = 0; rowData.originalPrice = 0; rowData.originalTotal = 0;
                                rowData.newQty = parseNum(item.changeQtyVal);
                            } else if (categoryType === 'NO_CHANGE') {
                                rowData.newQty = item.originalQty;
                            } else {
                                rowData.newQty = parseNum(item.changeQtyVal);
                            }
                            rowData.newPrice = item.originalPrice;
                            // 修正：金額與數量計算皆使用 round2 避免浮點數誤差
                            rowData.newTotal = round2(rowData.newQty * rowData.newPrice);
                            rowData.diffQty = round2(rowData.newQty - rowData.originalQty);
                            rowData.diffPrice = rowData.newPrice;
                            rowData.diffTotal = round2(rowData.diffQty * rowData.diffPrice);
                        }
                    } else {
                        const myLeaves = targetLeaves.filter(leaf => leaf.code.startsWith(item.code));
                        let sumOriginal = 0, sumNew = 0, sumDiff = 0;
                        myLeaves.forEach(leaf => {
                            const price = leaf.originalPrice;
                            let oQty = leaf.originalQty;
                            let nQty = oQty;
                            if (categoryType === 'NEW_ITEM') { oQty = 0; nQty = parseNum(leaf.changeQtyVal); }
                            else if (categoryType === 'NO_CHANGE') { nQty = oQty; }
                            else { nQty = parseNum(leaf.changeQtyVal); }
                            sumOriginal += oQty * price;
                            sumNew += nQty * price;
                            sumDiff += (nQty - oQty) * price;
                        });
                        rowData.originalQty = 1; rowData.originalPrice = sumOriginal; rowData.originalTotal = sumOriginal;
                        rowData.newQty = 1; rowData.newPrice = sumNew; rowData.newTotal = sumNew;
                        rowData.diffQty = 0; rowData.diffPrice = sumNew; rowData.diffTotal = sumDiff;
                    }
                    return rowData;
                });
            };

            // 5. 預先計算基礎項目 (011) 的總金額，供按比例計算使用
            const calculateBaseItemTotal = (allItems) => {
                const baseItem = allItems.find(i => i.code === BASE_ITEM_CODE);
                if (!baseItem) return 1; 
                // 使用 preprocess 計算出來的 originalTotal，它已經是 round2 過的結果
                return baseItem.originalTotal || 1;
            };

            const generateOutput = () => {
                const allItems = inputData.map((row, index) => ({
                    id: index,
                    code: String(row['工程項目'] || '').trim(),
                    name: row['項目名稱'],
                    unit: row['單位'],
                    originalQty: parseNum(row['數量']),
                    originalPrice: parseNum(row['單價']),
                    // 2. 使用系統計算過的金額 (來自 preprocessInputData)，保留2位小數
                    originalTotal: parseNum(row['金額合計']), 
                    changeQtyVal: row[changeQtyKey],
                    isRatioItem: !!row[ratioKey]
                }));

                const validationErrors = validateData(allItems);
                if (validationErrors.length > 0) {
                    alert("資料驗證錯誤：\n\n" + validationErrors.join("\n"));
                    setStatusMsg(""); return;
                }

                setStatusMsg('計算中...');
                const rawCat1 = generateRawCategoryItems(allItems, 'NO_CHANGE');
                const rawCat2 = generateRawCategoryItems(allItems, 'ADD');
                const rawCat3 = generateRawCategoryItems(allItems, 'DEDUCT');
                const rawCat4 = generateRawCategoryItems(allItems, 'NEW_ITEM');

                // 5. 獲取正確的包工費基底金額 (2位小數)
                const totalBaseAmount = calculateBaseItemTotal(allItems);

                const findBaseAmountInCategory = (catItems) => { const item = catItems.find(i => i.code === BASE_ITEM_CODE); return item ? item.newTotal : 0; };
                const findBaseOriginalInCat = (catItems) => { const item = catItems.find(i => i.code === BASE_ITEM_CODE); return item ? item.originalTotal : 0; };
                const injectBaseInfo = (items, baseNew, baseOriginal) => {
                    items.forEach(i => { if (i.isRatioItem) { i.categoryBaseNewTotal = baseNew; i.categoryBaseOriginalTotal = baseOriginal; i.rawOriginalTotal = i.originalTotal; } });
                };

                injectBaseInfo(rawCat1, findBaseAmountInCategory(rawCat1), findBaseOriginalInCat(rawCat1));
                injectBaseInfo(rawCat2, findBaseAmountInCategory(rawCat2), findBaseOriginalInCat(rawCat2));
                injectBaseInfo(rawCat3, findBaseAmountInCategory(rawCat3), findBaseOriginalInCat(rawCat3));
                injectBaseInfo(rawCat4, findBaseAmountInCategory(rawCat4), findBaseOriginalInCat(rawCat4)); 

                const applyRatioLogic = (items) => {
                    items.forEach(item => {
                        if (item.needsRatioCalc) {
                            const ratioNew = item.categoryBaseNewTotal / totalBaseAmount;
                            // 使用 round2 替代 Math.round
                            item.newPrice = round2(item.rawOriginalTotal * ratioNew); item.newTotal = item.newPrice; item.newQty = 1;
                            const ratioOriginal = item.categoryBaseOriginalTotal / totalBaseAmount;
                            item.originalPrice = round2(item.rawOriginalTotal * ratioOriginal); item.originalTotal = item.originalPrice; item.originalQty = 1;
                            item.diffQty = 0; item.diffPrice = item.newPrice - item.originalPrice; item.diffTotal = item.diffPrice;
                            item.formulaNewPrice = `${item.rawOriginalTotal} * I_BASE / ${totalBaseAmount}`;
                            item.formulaOriginalPrice = `${item.rawOriginalTotal} * F_BASE / ${totalBaseAmount}`;
                        }
                    });
                };
                applyRatioLogic(rawCat1); applyRatioLogic(rawCat2); applyRatioLogic(rawCat3); applyRatioLogic(rawCat4);

                const recalculateCategoryParents = (items) => {
                    const processOrder = [...items].sort((a, b) => b.code.length - a.code.length);
                    processOrder.forEach(item => {
                        if (!item.isLeaf) {
                            const descendants = items.filter(sub => sub.code.startsWith(item.code) && sub.code !== item.code);
                            const directChildren = descendants.filter(child => {
                                const hasMiddleMan = descendants.some(middle => middle.code !== child.code && child.code.startsWith(middle.code));
                                return !hasMiddleMan;
                            });
                            if (directChildren.length > 0) {
                                const sumOriginal = directChildren.reduce((acc, c) => acc + c.originalTotal, 0);
                                const sumNew = directChildren.reduce((acc, c) => acc + c.newTotal, 0);
                                const sumDiff = directChildren.reduce((acc, c) => acc + c.diffTotal, 0);
                                // 使用 round2
                                item.originalTotal = round2(sumOriginal); item.originalPrice = round2(sumOriginal);
                                item.newTotal = round2(sumNew); item.newPrice = round2(sumNew);
                                item.diffTotal = round2(sumDiff); item.diffPrice = round2(sumNew);
                            }
                        }
                    });
                };
                recalculateCategoryParents(rawCat1); recalculateCategoryParents(rawCat2); recalculateCategoryParents(rawCat3); recalculateCategoryParents(rawCat4);

                let rowCursor = 3; 
                let finalOutput = [];

                const processBlock = (title, items, categoryKey, bgColor) => {
                    if (items.length === 0) return;
                    finalOutput.push({ isHeader: true, title, category: categoryKey, bgColor });
                    rowCursor++; 
                    items.forEach(item => {
                        item.excelRow = rowCursor; item.category = categoryKey; finalOutput.push(item); rowCursor++;
                    });
                };

                processBlock('一、原項目無追加減', rawCat1, 'NO_CHANGE', '#DDEBF7');
                processBlock('二、原項目追加', rawCat2, 'ADD', '#E2EFDA');
                processBlock('三、原契約追減', rawCat3, 'DEDUCT', '#FCE4D6');
                processBlock('四、新增工項', rawCat4, 'NEW_ITEM', '#E7E6E6');

                const addSummaryBlock = () => {
                    finalOutput.push({ isHeader: true, title: '五、總表', category: 'SUMMARY', bgColor: '#FFF2CC' });
                    rowCursor++;
                    const has0B = allItems.some(i => i.code === '0B');
                    const summaryTargets = [...SUMMARY_CODES];
                    if (!summaryTargets.includes('0B')) summaryTargets.push('0B'); 

                    summaryTargets.forEach(code => {
                        const rowData = {
                            code: code, name: '', unit: '', excelRow: rowCursor, category: 'SUMMARY', isSummaryItem: true, 
                            originalQty: 1, originalPrice: 0, originalTotal: 0, newQty: 1, newPrice: 0, newTotal: 0, diffQty: 0, diffPrice: 0, diffTotal: 0, formulaOriginalPrice: null, formulaNewPrice: null
                        };
                        const baseItem = allItems.find(i => i.code === code);
                        if (baseItem) { rowData.name = baseItem.name; rowData.unit = baseItem.unit; } else if (code === '0B') { rowData.name = '營業稅'; rowData.unit = '式'; }

                        if (code === '0B' && !has0B) {
                            rowData.isArtificialTax = true; 
                        } else {
                            const sourceRows = finalOutput.filter(item => !item.isHeader && item.category !== 'SUMMARY' && item.code === code);
                            const sumOriginal = sourceRows.reduce((acc, r) => acc + r.originalTotal, 0);
                            const sumNew = sourceRows.reduce((acc, r) => acc + r.newTotal, 0);
                            const sumDiff = sourceRows.reduce((acc, r) => acc + r.diffTotal, 0);
                            // 使用 round2
                            rowData.originalPrice = round2(sumOriginal); rowData.originalTotal = round2(sumOriginal);
                            rowData.newPrice = round2(sumNew); rowData.newTotal = round2(sumNew); rowData.diffTotal = round2(sumDiff);
                            if (sourceRows.length > 0) {
                                const rowIndices = sourceRows.map(r => r.excelRow);
                                rowData.formulaOriginalPrice = '=' + rowIndices.map(r => `F${r}`).join('+');
                                rowData.formulaNewPrice = '=' + rowIndices.map(r => `I${r}`).join('+');
                            }
                        }
                        finalOutput.push(rowData);
                        rowCursor++;
                    });

                    const row0B = finalOutput.find(i => i.isArtificialTax);
                    const row01 = finalOutput.find(i => i.category === 'SUMMARY' && i.code === '01');
                    if (row0B && row01) {
                        // 稅金計算使用 round2
                        row0B.originalPrice = round2(row01.originalPrice * 0.05); row0B.originalTotal = row0B.originalPrice;
                        row0B.newPrice = round2(row01.newPrice * 0.05); row0B.newTotal = row0B.newPrice; row0B.diffTotal = row0B.newTotal - row0B.originalTotal;
                        row0B.formulaOriginalPrice = `=ROUND(F${row01.excelRow}*0.05, 2)`;
                        row0B.formulaNewPrice = `=ROUND(I${row01.excelRow}*0.05, 2)`;
                    }

                    const row01Summary = finalOutput.find(i => i.category === 'SUMMARY' && i.code === '01');
                    const row0BSummary = finalOutput.find(i => i.category === 'SUMMARY' && i.code === '0B');
                    const totalRow = {
                        code: '', name: '總計', unit: '', excelRow: rowCursor, category: 'SUMMARY', isTotalRow: true, bgColor: '#D9D9D9',
                        originalQty: '', originalPrice: '', originalTotal: (row01Summary?.originalTotal || 0) + (row0BSummary?.originalTotal || 0),
                        newQty: '', newPrice: '', newTotal: (row01Summary?.newTotal || 0) + (row0BSummary?.newTotal || 0),
                        diffQty: '', diffPrice: '', diffTotal: (row01Summary?.diffTotal || 0) + (row0BSummary?.diffTotal || 0),
                        formulaOriginalTotal: row01Summary && row0BSummary ? `=F${row01Summary.excelRow}+F${row0BSummary.excelRow}` : null,
                        formulaNewTotal: row01Summary && row0BSummary ? `=I${row01Summary.excelRow}+I${row0BSummary.excelRow}` : null,
                        formulaDiffTotal: row01Summary && row0BSummary ? `=L${row01Summary.excelRow}+L${row0BSummary.excelRow}` : null
                    };
                    finalOutput.push(totalRow); rowCursor++;
                };

                if (finalOutput.length > 0) { addSummaryBlock(); }
                if (finalOutput.length === 0) { alert("無資料"); return; }

                const rowMap = {};
                finalOutput.forEach(item => { if (!item.isHeader) { rowMap[`${item.category}_${item.code}`] = item.excelRow; } });

                finalOutput.forEach(item => {
                    if (!item.isHeader && !item.isSummaryItem && !item.isTotalRow) { 
                        if (item.isRatioItem && item.formulaNewPrice) {
                            const baseRow = rowMap[`${item.category}_${BASE_ITEM_CODE}`];
                            if (baseRow) {
                                item.formulaOriginalPrice = item.formulaOriginalPrice.replace('F_BASE', `F${baseRow}`);
                                item.formulaNewPrice = item.formulaNewPrice.replace('I_BASE', `I${baseRow}`);
                            } else {
                                item.formulaOriginalPrice = null; item.formulaNewPrice = null;
                            }
                        } else if (!item.isLeaf) {
                            const categoryItems = finalOutput.filter(i => !i.isHeader && i.category === item.category);
                            const descendants = categoryItems.filter(sub => sub.code.startsWith(item.code) && sub.code !== item.code);
                            const directChildren = descendants.filter(child => {
                                const hasMiddleMan = descendants.some(middle => middle.code !== child.code && child.code.startsWith(middle.code));
                                return !hasMiddleMan;
                            });
                            if (directChildren.length > 0) {
                                const rowIndices = directChildren.map(child => rowMap[`${child.category}_${child.code}`]);
                                item.formulaPrice = '=' + rowIndices.map(r => `F${r}`).join('+');
                            }
                        }
                    }
                });

                setOutputData(finalOutput);
                setStep(3);
                setStatusMsg(''); 
            };

            const exportToExcel = () => {
                if (!window.XLSX) return;
                const wb = window.XLSX.utils.book_new();
                const wsData = [];
                
                // --- 樣式設定輔助函式 ---
                const thinBorder = {
                    top: { style: "thin", color: { auto: 1 } },
                    bottom: { style: "thin", color: { auto: 1 } },
                    left: { style: "thin", color: { auto: 1 } },
                    right: { style: "thin", color: { auto: 1 } }
                };

                const numFmt = "#,##0.00"; 
                
                // 統一字體設定
                const baseFont = { name: "Noto Sans CJK TC Regular", sz: 14 };

                const createCell = (value, type, bgColor = null, bold = false, align = null) => {
                    const cell = { v: value, t: type };
                    if (type === 'n') cell.z = numFmt; 
                    cell.s = {
                        font: { ...baseFont, bold: bold },
                        alignment: { wrapText: true, vertical: "center" },
                        border: thinBorder
                    };
                    if (bgColor) {
                        const hex = bgColor.replace('#', '');
                        cell.s.fill = { fgColor: { rgb: hex } };
                    }
                    if (align) {
                        cell.s.alignment.horizontal = align;
                    }
                    return cell;
                };

                // Header Row 1
                const headers1 = [
                    "工程項目", "項目名稱", "單位", 
                    "原契約", "", "", 
                    "變更後", "", "", 
                    "變更增減", "", "",
                    "變更簽文字"
                ];
                
                // Header Row 2
                const headers2 = [
                    "", "", "", 
                    "數量", "單價", "金額", 
                    "數量", "單價", "金額", 
                    "數量", "單價", "金額",
                    ""
                ];

                wsData.push(headers1.map(h => createCell(h, 's', '#EFEFEF', true, 'center')));
                wsData.push(headers2.map(h => createCell(h, 's', '#EFEFEF', true, 'center')));

                const merges = [
                    { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, // 工程項目
                    { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } }, // 項目名稱
                    { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } }, // 單位
                    { s: { r: 0, c: 3 }, e: { r: 0, c: 5 } }, // 原契約合併
                    { s: { r: 0, c: 6 }, e: { r: 0, c: 8 } }, // 變更後合併
                    { s: { r: 0, c: 9 }, e: { r: 0, c: 11 } }, // 變更增減合併
                    { s: { r: 0, c: 12 }, e: { r: 1, c: 12 } } // 變更簽文字
                ]; 

                outputData.forEach((item) => {
                    const currentRowIdx = wsData.length; 

                    if (item.isHeader) {
                        // 標題列 (例如：一、原項目無追加減)
                        // A欄 (Index 0) 放標題
                        const cellTitle = createCell(item.title, 's', item.bgColor, true, 'left');
                        
                        const row = [cellTitle];
                        
                        // B~L欄 (Index 1~11) 填空並上色，保持格線
                        for(let i=1; i<=11; i++) {
                            row.push(createCell("", 's', item.bgColor));
                        }

                        // M欄 (Index 12) 無色無格線
                        const cellM = createCell("", 's');
                        cellM.s.border = {}; // Remove border for M
                        row.push(cellM);

                        wsData.push(row);
                        
                        // 合併 A(0) 到 L(11)
                        merges.push({ s: { r: currentRowIdx, c: 0 }, e: { r: currentRowIdx, c: 11 } });

                    } else {
                        const r = item.excelRow;
                        const bgColor = item.isTotalRow ? '#D9D9D9' : 
                                      item.isRatioItem ? '#FFF5E6' : 
                                      item.isSummaryItem ? '#FCF8E3' : null;
                        const isBold = item.isTotalRow;

                        // 公式與數值處理
                        const cellOriginalAmount = { f: `ROUND(D${r}*E${r}, 2)`, t: 'n', z: numFmt }; 
                        const cellNewAmount = { f: `ROUND(G${r}*H${r}, 2)`, t: 'n', z: numFmt };
                        const cellDiffAmount = { f: `ROUND(J${r}*K${r}, 2)`, t: 'n', z: numFmt };

                        let cellOriginalPrice = { v: item.originalPrice, t: 'n', z: numFmt };
                        let cellNewPrice = { v: item.newPrice, t: 'n', z: numFmt };
                        
                        // J, K, L Unified Formulas
                        // J: G-D (Diff Qty) with hiding if zero
                        let cellDiffQty = { t: 'n', z: numFmt, f: `IF(G${r}-D${r}=0,"",G${r}-D${r})` };
                        // K: IF(H=E, E, H-E) (Diff Price)
                        let cellDiffPrice = { t: 'n', z: numFmt, f: `IF(H${r}=E${r},E${r},H${r}-E${r})` };
                        // L: I-F (Diff Amount)
                        let cellDiffAmountUnified = { t: 'n', z: numFmt, f: `I${r}-F${r}` };

                        let cellMemo = { v: '', t: 's' };

                        // 套用樣式到這些特殊 Cell，確保字體統一
                        [cellOriginalAmount, cellNewAmount, cellDiffAmountUnified, cellOriginalPrice, cellNewPrice, cellDiffPrice, cellDiffQty, cellMemo].forEach(c => {
                            c.s = { font: { ...baseFont, bold: isBold }, border: thinBorder, alignment: { vertical: "center" } };
                            if (bgColor) c.s.fill = { fgColor: { rgb: bgColor.replace('#', '') } };
                        });

                        // 總計列處理
                        if (item.isTotalRow) {
                            const totalStyle = { font: { ...baseFont, bold: true }, fill: { fgColor: { rgb: "D9D9D9" } }, border: thinBorder };
                            
                            const cellTotalOriginal = { f: item.formulaOriginalTotal, t: 'n', z: numFmt, s: totalStyle };
                            const cellTotalNew = { f: item.formulaNewTotal, t: 'n', z: numFmt, s: totalStyle };
                            const cellTotalDiff = { f: `I${r}-F${r}`, t: 'n', z: numFmt, s: totalStyle };
                            
                            const emptyStyled = (bg) => createCell("", 's', bg, true);

                            const row = [
                                emptyStyled('#D9D9D9'), 
                                createCell('總計', 's', '#D9D9D9', true, 'right'), 
                                emptyStyled('#D9D9D9'),
                                emptyStyled('#D9D9D9'), 
                                emptyStyled('#D9D9D9'), 
                                cellTotalOriginal,
                                emptyStyled('#D9D9D9'), 
                                emptyStyled('#D9D9D9'), 
                                cellTotalNew,
                                emptyStyled('#D9D9D9'), 
                                emptyStyled('#D9D9D9'), 
                                cellTotalDiff,
                                emptyStyled('#D9D9D9')
                            ];
                            wsData.push(row);
                            return;
                        }

                        // 公式邏輯處理
                        if (item.isSummaryItem) {
                            if (item.formulaOriginalPrice) {
                                cellOriginalPrice.f = item.formulaOriginalPrice; delete cellOriginalPrice.v;
                                cellNewPrice.f = item.formulaNewPrice; delete cellNewPrice.v;
                            }
                        } else if (item.isRatioItem && item.formulaNewPrice) {
                            cellOriginalPrice.f = `=ROUND(${item.formulaOriginalPrice}, 2)`; delete cellOriginalPrice.v;
                            cellNewPrice.f = `=ROUND(${item.formulaNewPrice}, 2)`; delete cellNewPrice.v;
                        } else if (!item.isLeaf && item.formulaPrice) {
                            cellOriginalPrice.f = item.formulaPrice; delete cellOriginalPrice.v;
                            cellNewPrice.f = item.formulaPrice.replace(/F/g, 'I'); delete cellNewPrice.v;
                        }

                        if (!item.isSummaryItem && !item.isRatioItem && !item.isTotalRow && item.isLeaf) {
                            if (['ADD', 'DEDUCT', 'NEW_ITEM'].includes(item.category)) {
                                const fmt = (ref) => `IF(MOD(${ref},1)=0,TEXT(${ref},"#,###"),TEXT(${ref},"#,###.##"))`;
                                let formulaStr = "";
                                if (item.category === 'DEDUCT') {
                                    formulaStr = `"「"&A${r}&" "&B${r}&"」：原契約數量"&${fmt(`D${r}`)}&C${r}&"，單價為"&${fmt(`H${r}`)}&"元，追減數量"&${fmt(`ABS(J${r})`)}&C${r}&"，追減金額"&${fmt(`ABS(L${r})`)}&"元。"`;
                                } else if (item.originalQty === 0) {
                                     formulaStr = `"「"&A${r}&" "&B${r}&"」：新增數量"&${fmt(`J${r}`)}&C${r}&"，單價為"&${fmt(`H${r}`)}&"元，新增追加金額"&${fmt(`L${r}`)}&"元。"`;
                                } else {
                                    formulaStr = `"「"&A${r}&" "&B${r}&"」：原契約數量"&${fmt(`D${r}`)}&C${r}&"，單價為"&${fmt(`H${r}`)}&"元，追加數量"&${fmt(`J${r}`)}&C${r}&"，追加金額"&${fmt(`L${r}`)}&"元。"`;
                                }
                                cellMemo.f = formulaStr; delete cellMemo.v;
                            }
                        }

                        // 建立完整 Row
                        const row = [
                            createCell(item.code, 's', bgColor),
                            createCell(item.name, 's', bgColor),
                            createCell(item.unit, 's', bgColor, false, 'center'),
                            createCell(item.originalQty, 'n', bgColor, false, 'right'),
                            cellOriginalPrice,
                            cellOriginalAmount,
                            createCell(item.newQty, 'n', bgColor, false, 'right'),
                            cellNewPrice,
                            cellNewAmount,
                            cellDiffQty,
                            cellDiffPrice,
                            cellDiffAmountUnified,
                            cellMemo
                        ];
                        wsData.push(row);
                    }
                });

                const ws = window.XLSX.utils.aoa_to_sheet([]);
                window.XLSX.utils.sheet_add_aoa(ws, wsData, { origin: "A1" });
                ws['!merges'] = merges;
                ws['!cols'] = [
                    { wch: 15 }, // A
                    { wch: 40 }, // B
                    { wch: 8 },  // C
                    { wch: 10 }, // D
                    { wch: 25 }, // E
                    { wch: 25 }, // F
                    { wch: 10 }, // G
                    { wch: 25 }, // H
                    { wch: 25 }, // I
                    { wch: 10 }, // J
                    { wch: 25 }, // K
                    { wch: 25 }, // L
                    { wch: 60 }  // M
                ];
                window.XLSX.utils.book_append_sheet(wb, ws, "變更明細表");
                window.XLSX.writeFile(wb, `變更明細_${fileName || 'export.xlsx'}`);
            };

            const reset = () => { setStep(1); setInputData([]); setOutputData([]); setFileName(''); if(fileInputRef.current) fileInputRef.current.value = ''; };

            return (
                <div style={{ fontFamily: 'sans-serif', padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
                    <h1 style={{ color: 'black' }}>工程預算變更工具</h1>
                    <hr />
                    
                    <div style={{ marginBottom: '20px' }}>
                        <strong>步驟：</strong> 
                        <span style={step === 1 ? { fontWeight: 'bold' } : { color: '#999' }}> 1. 上傳 </span> &gt;
                        <span style={step === 2 ? { fontWeight: 'bold' } : { color: '#999' }}> 2. 輸入 </span> &gt;
                        <span style={step === 3 ? { fontWeight: 'bold' } : { color: '#999' }}> 3. 下載 </span>
                        <span style={{ marginLeft: '15px', color: 'red' }}>{statusMsg}</span>
                    </div>

                    {step === 1 && (
                        <div style={{ border: '1px solid #ccc', padding: '30px', textAlign: 'center' }}>
                            <p>請上傳原契約預算 Excel 檔案</p>
                            <input type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} ref={fileInputRef} disabled={!libLoaded} />
                            <br/><br/>
                            <button onClick={downloadTemplate} disabled={!libLoaded}>下載空白範本</button>
                            <div style={{ marginTop: '20px', textAlign: 'left', background: '#f0f0f0', padding: '10px' }}>
                                <strong>說明：</strong>
                                <ol>
                                    <li>下載空白預算書，將原契約工項依範本欄位填入。</li>
                                    <li>需變更之項目，填寫變更後數量。</li>
                                    <li>新增工項，在原契約數量填入0，在變更後數量填入新增工項數量。</li>
                                    <li>需按比例調整之工項（如不可量化、承商利稅等），在按比例欄輸入V，或在第二步勾選，系統會依包工費比例拆分。</li>
                                </ol>
                            </div>
                        </div>
                    )}

                    {step === 2 && (
                        <div>
                            <div style={{ marginBottom: '10px' }}>
                                <button onClick={reset} style={{ marginRight: '5px' }}>取消</button>
                                <button onClick={generateOutput}>轉換</button>
                            </div>
                            <table border="1" cellPadding="5" style={{ width: '80%', borderCollapse: 'collapse' }} align="center">
                                <thead style={{ background: '#eee' }}>
                                    <tr>
                                        <th style={{ width: '10%' }}>項目</th><th>名稱</th><th style={{ width: '5%' }}>單位</th><th style={{ width: '15%' }}>原數量</th>
                                        <th style={{ background: '#e6f7ff', width: '100px' }}>變更後數量</th>
                                        <th style={{ background: '#fff7e6', width: '15%'  }}>按比例</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        const rowsWithIndex = inputData.map((row, idx) => ({ ...row, _origIdx: idx }));
                                        const existing = rowsWithIndex.filter(r => parseNum(r['數量']) !== 0);
                                        const newItems = rowsWithIndex.filter(r => parseNum(r['數量']) === 0);

                                        return (
                                            <>
                                                {existing.map(row => (
                                                    <tr key={row._origIdx}>
                                                        <td>{row['工程項目']}</td><td>{row['項目名稱']}</td>
                                                        <td align="center">{row['單位']}</td><td align="right">{row['數量']}</td>
                                                        <td style={{ background: '#e6f7ff' }}>
                                                            <input type="text" value={row[changeQtyKey] !== undefined ? row[changeQtyKey] : ''} onChange={(e) => handleInputChange(row._origIdx, changeQtyKey, e.target.value)} style={{ width: '90%' }} />
                                                        </td>
                                                        <td align="center" style={{ background: '#fff7e6' }}>
                                                            <input type="checkbox" checked={!!row[ratioKey]} onChange={(e) => handleInputChange(row._origIdx, ratioKey, e.target.checked ? 'V' : '')} />
                                                        </td>
                                                    </tr>
                                                ))}
                                                
                                                {newItems.length > 0 && (
                                                    <tr style={{ background: '#d9d9d9' }}>
                                                        <td colSpan="6" align="center" style={{ fontWeight: 'bold', padding: '8px' }}>新增工項</td>
                                                    </tr>
                                                )}

                                                {newItems.map(row => (
                                                    <tr key={row._origIdx} style={{ background: '#eaf4db' }}>
                                                        <td>{row['工程項目']}</td><td>{row['項目名稱']}</td>
                                                        <td align="center">{row['單位']}</td><td align="right" style={{ color: '#999' }}>{row['數量']}</td>
                                                        <td style={{ background: '#cceeff' }}>
                                                            <input type="text" value={row[changeQtyKey] !== undefined ? row[changeQtyKey] : ''} onChange={(e) => handleInputChange(row._origIdx, changeQtyKey, e.target.value)} style={{ width: '90%' }} />
                                                        </td>
                                                        <td align="center" style={{ background: '#fff0d0' }}>
                                                            <input type="checkbox" checked={!!row[ratioKey]} onChange={(e) => handleInputChange(row._origIdx, ratioKey, e.target.checked ? 'V' : '')} />
                                                        </td>
                                                    </tr>
                                                ))}
                                            </>
                                        );
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {step === 3 && (
                        <div>
                            <div style={{ marginBottom: '10px' }}>
                                <button onClick={() => setStep(2)} style={{ marginRight: '5px' }}>修改</button>
                                <button onClick={exportToExcel}>下載 Excel</button>
                            </div>
                            <div style={{ overflowX: 'auto' }}>
                                <table border="1" cellPadding="4" style={{ width: '100%', borderCollapse: 'collapse', whiteSpace: 'nowrap' }}>
                                    <thead>
                                        <tr style={{ background: '#f0f0f0' }}>
                                            <th rowSpan="2">項目</th><th rowSpan="2">名稱</th>
                                            <th colSpan="3" style={{ background: '#d9edf7' }}>原契約</th>
                                            <th colSpan="3" style={{ background: '#dff0d8' }}>變更後</th>
                                            <th colSpan="3" style={{ background: '#fcf8e3' }}>增減</th>
                                        </tr>
                                        <tr style={{ background: '#f9f9f9' }}>
                                            <th>數量</th><th>單價</th><th>金額</th><th>數量</th><th>單價</th><th>金額</th><th>數量</th><th>單價</th><th>金額</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {outputData.map((row, idx) => {
                                            if (row.isHeader) return <tr key={idx} style={{ background: row.bgColor }}><td></td><td colSpan="11"><b>{row.title}</b></td></tr>;
                                            if (row.isTotalRow) return <tr key={idx} style={{ background: row.bgColor, fontWeight: 'bold' }}><td colSpan="4" align="right">總計</td><td align="right">{formatNum(row.originalTotal)}</td><td colSpan="2"></td><td align="right">{formatNum(row.newTotal)}</td><td colSpan="2"></td><td align="right">{formatNum(row.diffTotal)}</td></tr>;
                                            return (
                                                <tr key={idx} style={{ background: row.isRatioItem ? '#fff5e6' : (row.isSummaryItem ? '#fcf8e3' : '#fff') }}>
                                                    <td>{row.code}</td><td>{row.name}</td>
                                                    <td align="right">{row.isSummaryItem ? '' : row.originalQty}</td><td align="right">{row.isSummaryItem ? '' : formatNum(row.originalPrice)}</td><td align="right">{formatNum(row.originalTotal)}</td>
                                                    <td align="right">{row.isSummaryItem ? '' : row.newQty}</td><td align="right">{row.isSummaryItem ? '' : formatNum(row.newPrice)}</td><td align="right">{formatNum(row.newTotal)}</td>
                                                    <td align="right">{row.isSummaryItem ? '' : row.diffQty}</td><td align="right">{row.isSummaryItem ? '' : formatNum(row.diffPrice)}</td><td align="right">{formatNum(row.diffTotal)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExcelProcessor />);
    </script>
</body>
</html>

